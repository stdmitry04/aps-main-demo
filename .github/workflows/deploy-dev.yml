name: Deploy & Check Vercel

on:
  pull_request:
    branches: [ dev ]
  push:
    branches: [ dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Vercel deploy
        id: deploy
        run: |
          echo "Triggering Vercel deployment..."
          response=$(curl -s -X POST "${{ secrets.VERCEL_DEV_DEPLOY_HOOK_URL }}")
          echo "Deploy hook triggered"
          echo "$response"

      - name: Wait for deployment to finish
        id: wait
        run: |
          echo "Waiting for deployment to appear in API..."
          DEPLOYMENT_ID=""

          # Try to fetch deployment ID with retries (up to 60 seconds)
          for attempt in {1..12}; do
            echo "Attempt $attempt: Fetching latest deployment..."
            response=$(curl -s "https://api.vercel.com/v6/deployments?limit=1&projectId=${{ secrets.VERCEL_PROJECT_ID }}" \
              -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}")

            echo "API Response: $response"

            DEPLOYMENT_ID=$(echo "$response" | jq -r '.deployments[0].uid // empty')

            if [ -n "$DEPLOYMENT_ID" ] && [ "$DEPLOYMENT_ID" != "null" ]; then
              echo "Found deployment ID: $DEPLOYMENT_ID"
              break
            fi

            echo "Deployment not found yet, waiting 5 seconds..."
            sleep 5
          done

          if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" = "null" ]; then
            echo "Failed to get deployment ID after 60 seconds"
            exit 1
          fi

          echo "Monitoring deployment $DEPLOYMENT_ID..."

          # Monitor deployment status
          for i in {1..30}; do
            response=$(curl -s "https://api.vercel.com/v6/deployments/$DEPLOYMENT_ID" \
              -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}")

            STATUS=$(echo "$response" | jq -r '.readyState // empty')
            echo "Status: $STATUS"

            if [ "$STATUS" = "READY" ]; then
              echo "‚úÖ Deployment successful!"
              exit 0
            fi
            if [ "$STATUS" = "ERROR" ]; then
              echo "‚ùå Deployment failed!"
              exit 1
            fi
            sleep 10
          done

          echo "‚è±Ô∏è Timed out waiting for Vercel build"
          exit 1

      - name: Comment on PR (failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "üö® Vercel build failed. Please fix before merging."
            })
