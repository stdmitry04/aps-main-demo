name: Deploy & Check Vercel

on:
  pull_request:
    branches: [ dev ]
  push:
    branches: [ dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Vercel deploy
        id: deploy
        run: |
          response=$(curl -s -X POST "$VERCEL_DEPLOY_HOOK_URL?target=preview")
          echo "$response"
          DEPLOYMENT_URL=$(echo $response | jq -r '.url')
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        env:
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}

      - name: Wait for deployment to finish
        id: wait
        run: |
          DEPLOYMENT_ID=$(curl -s "https://api.vercel.com/v6/deployments?url=${{ steps.deploy.outputs.deployment_url }}" \
            | jq -r '.deployments[0].uid')
          echo "Checking deployment $DEPLOYMENT_ID"
          for i in {1..30}; do
            STATUS=$(curl -s "https://api.vercel.com/v6/deployments/$DEPLOYMENT_ID" \
              | jq -r '.readyState')
            echo "Status: $STATUS"
            if [ "$STATUS" = "READY" ]; then exit 0; fi
            if [ "$STATUS" = "ERROR" ]; then exit 1; fi
            sleep 10
          done
          echo "Timed out waiting for Vercel build"
          exit 1

      - name: Comment on PR (failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ðŸš¨ Vercel build failed. Please fix before merging."
            })
